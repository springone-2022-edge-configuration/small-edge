name: push-config
run-name: ${{ github.actor }} is learning GitHub Actions
on: [push]
jobs:
  check-bats-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install packages
        run: |
          mkdir local-bin/
          curl -L https://carvel.dev/install.sh | K14SIO_INSTALL_BIN_DIR=local-bin bash 
          export PATH=$PWD/local-bin/:$PATH
          echo $PATH
          imgpkg version
          ytt version
      - name: Download imgpkg bundle
        run: /home/runner/work/small-edge/small-edge/local-bin/imgpkg pull -b marygabry1508/hello-app-bundle:v1.0.0 -o hello-app-bundle
      - name: Apply ytt transformation
        run: |
          for valuesfile in ./values/*.yml
          do 
            echo "Processing $valuesfile file...";
            /home/runner/work/small-edge/small-edge/local-bin/ytt -f hello-app-bundle/config \
            -f hello-app-bundle/.imgpkg/images.yml \
            -f overlay-small.yml \
            --data-values-file $valuesfile \
            | kbld -f- \
            > edges/$(basename $valuesfile);
          done
      - name: Pushes yaml to edge repo
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          source-directory: 'edges'
          destination-github-username: 'springone-2022-edge-configuration'
          destination-repository-name: 'small-edge-sicilia'
          user-email: mbrodi@vmware.com
          target-branch: main
          commit-message: "update"
